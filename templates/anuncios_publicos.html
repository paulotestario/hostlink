{% extends "base.html" %}

{% block title %}Anúncios Disponíveis - HostLink{% endblock %}

{% block extra_css %}
<style>
    .listing-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
        transition: box-shadow 0.3s;
    }
    .listing-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .listing-image {
        height: 200px;
        object-fit: cover;
        border-radius: 8px 8px 0 0;
    }
    .price-badge {
        background: #28a745;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: bold;
    }
    .calendar-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    .btn-reserve {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
    }
    .btn-reserve:hover {
        background: #0056b3;
    }
    .calendar-widget {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fa;
    }
    .calendar-header h6 {
        margin: 0;
        color: #495057;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-top: 10px;
    }
    .calendar-day {
        padding: 8px 4px;
        text-align: center;
        font-size: 12px;
        border-radius: 4px;
        border: 1px solid #e9ecef;
    }
    .calendar-day.available {
        background: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
    }
    .calendar-day.unavailable {
        background: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }
    .calendar-day.header {
        background: #6c757d;
        color: white;
        font-weight: bold;
    }
    .calendar-day.other-month {
        color: #6c757d;
        background: #f8f9fa;
    }
    
    /* Modal Calendar Styles */
    .calendar-modal .modal-dialog {
        max-width: 600px;
    }
    .calendar-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .calendar-nav-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    }
    .calendar-nav-btn:hover {
        background: #0056b3;
    }
    .calendar-nav-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    .calendar-month-title {
        font-size: 18px;
        font-weight: bold;
        color: #495057;
    }
    .calendar-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 15px;
        font-size: 12px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        border: 1px solid #dee2e6;
    }
    .legend-available {
        background: #d4edda;
        border-color: #c3e6cb;
    }
    .legend-unavailable {
        background: #f8d7da;
        border-color: #f5c6cb;
    }
    
    /* Estilos para seleção de datas */
    .date-selection-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .selected-date {
        background-color: white;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        min-height: 38px;
        display: flex;
        align-items: center;
        color: #6c757d;
    }
    
    .selected-date.has-date {
        color: #198754;
        font-weight: 500;
    }
    
    .calendar-day.selectable {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .calendar-day.selectable:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .calendar-day.selected-checkin {
        background-color: #198754 !important;
        color: white;
        font-weight: bold;
    }
    
    .calendar-day.selected-checkout {
        background-color: #0d6efd !important;
        color: white;
        font-weight: bold;
    }
    
    .calendar-day.in-range {
        background-color: #e7f3ff !important;
        color: #0d6efd;
    }
    
    .btn-reserve-modal {
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}

    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-search"></i> Anúncios Disponíveis
        </h1>

        <!-- Filtro por Data -->
        <div class="calendar-container">
            <h4><i class="fas fa-calendar-alt"></i> Filtrar por Período</h4>
            <div class="row">
                <div class="col-md-3">
                    <label for="filter-date-start" class="form-label">Data de Entrada:</label>
                    <input type="date" id="filter-date-start" class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="filter-date-end" class="form-label">Data de Saída:</label>
                    <input type="date" id="filter-date-end" class="form-control">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button id="filter-btn" class="btn btn-primary me-2">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                    <button id="clear-filter-btn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Anúncios -->
        <div id="listings-container" class="row">
            <!-- Os anúncios serão carregados aqui via JavaScript -->
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>

        <!-- Mensagem quando não há anúncios -->
        <div id="no-listings" class="text-center" style="display: none;">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Nenhum anúncio encontrado para a data selecionada.
            </div>
        </div>
    </div>

    <!-- Modal de Reserva -->
    <div class="modal fade" id="reserveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Fazer Reserva</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reserve-form">
                        <input type="hidden" id="listing-id">
                        <div class="mb-3">
                            <label for="guest-name" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="guest-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="guest-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="guest-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="guest-phone" class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="guest-phone" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="check-in" class="form-label">Check-in</label>
                                <input type="date" class="form-control" id="check-in" required>
                            </div>
                            <div class="col-md-6">
                                <label for="check-out" class="form-label">Check-out</label>
                                <input type="date" class="form-control" id="check-out" required>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="guests-count" class="form-label">Número de Hóspedes</label>
                            <input type="number" class="form-control" id="guests-count" min="1" value="1" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirm-reserve">Confirmar Reserva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal da Agenda -->
    <div class="modal fade calendar-modal" id="calendarModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="calendarModalTitle">
                        <i class="fas fa-calendar-alt"></i> Agenda de Disponibilidade
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Navegação do Calendário -->
                    <div class="calendar-navigation">
                        <button class="calendar-nav-btn" id="prevMonth" onclick="changeMonth(-1)">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <div class="calendar-month-title" id="currentMonthTitle"></div>
                        <button class="calendar-nav-btn" id="nextMonth" onclick="changeMonth(1)">
                            Próximo <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Legenda -->
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <div class="legend-color legend-available"></div>
                            <span>Disponível</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-unavailable"></div>
                            <span>Indisponível</span>
                        </div>
                    </div>
                    
                    <!-- Loading -->
                    <div class="text-center" id="modalCalendarLoading" style="display: none;">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <small class="text-muted ms-2">Carregando agenda...</small>
                    </div>
                    
                    <!-- Seleção de Datas -->
                    <div class="date-selection-info" id="dateSelectionInfo" style="display: none;">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Check-in:</label>
                                <div class="selected-date" id="selectedCheckInDate">Selecione uma data</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Check-out:</label>
                                <div class="selected-date" id="selectedCheckOutDate">Selecione uma data</div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-success btn-reserve-modal" id="reserveFromCalendarBtn" onclick="openReserveFromCalendar()" style="display: none;">
                                    <i class="fas fa-calendar-check"></i> Reservar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conteúdo do Calendário -->
                    <div id="modalCalendarContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentListings = [];
        let filteredDate = null;

        // Carregar anúncios ao inicializar a página
        document.addEventListener('DOMContentLoaded', function() {
            loadListings();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('filter-btn').addEventListener('click', filterByDate);
            document.getElementById('clear-filter-btn').addEventListener('click', clearFilter);
            document.getElementById('confirm-reserve').addEventListener('click', confirmReservation);
        }

        async function loadListings() {
            showLoading(true);
            try {
                const response = await fetch('/api/anuncios/todos');
                const data = await response.json();
                
                if (data.success) {
                    currentListings = data.listings;
                    displayListings(currentListings);
                } else {
                    showError('Erro ao carregar anúncios: ' + data.message);
                }
            } catch (error) {
                showError('Erro ao carregar anúncios: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function filterByDate() {
            const startDateInput = document.getElementById('filter-date-start');
            const endDateInput = document.getElementById('filter-date-end');
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (!startDate || !endDate) {
                alert('Por favor, selecione as datas de entrada e saída.');
                return;
            }

            if (new Date(startDate) >= new Date(endDate)) {
                alert('A data de saída deve ser posterior à data de entrada.');
                return;
            }

            filteredDate = { start: startDate, end: endDate };
            showLoading(true);
            
            try {
                const response = await fetch(`/api/anuncios/periodo?data_inicio=${startDate}&data_fim=${endDate}`);
                const data = await response.json();
                
                if (data.success) {
                    displayListings(data.listings);
                } else {
                    showError('Erro ao filtrar anúncios: ' + data.message);
                }
            } catch (error) {
                showError('Erro ao filtrar anúncios: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function clearFilter() {
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            filteredDate = null;
            displayListings(currentListings);
        }

        function displayListings(listings) {
            const container = document.getElementById('listings-container');
            const noListings = document.getElementById('no-listings');
            
            if (listings.length === 0) {
                container.innerHTML = '';
                noListings.style.display = 'block';
                return;
            }
            
            noListings.style.display = 'none';
            
            container.innerHTML = listings.map(listing => {
                let availabilityInfo = '';
                let buttonClass = 'btn-reserve';
                let buttonText = '<i class="fas fa-calendar-check"></i> Reservar';
                let buttonDisabled = '';
                
                // Verificar se há reservas pendentes
                let pendingInfo = '';
                if (listing.has_pending_bookings && listing.pending_periods && listing.pending_periods.length > 0) {
                    const pendingPeriods = listing.pending_periods.map(period => {
                        const startDate = new Date(period.start).toLocaleDateString('pt-BR');
                        const endDate = new Date(period.end).toLocaleDateString('pt-BR');
                        return `${startDate} - ${endDate}`;
                    }).join(', ');
                    
                    pendingInfo = `
                        <div class="mt-2">
                            <small class="text-warning">
                                <i class="fas fa-clock"></i> Períodos com reserva pendente: ${pendingPeriods}
                            </small>
                        </div>`;
                }
                
                // Verificar se há reservas pendentes - desabilitar botão se houver
                if (listing.has_pending_bookings && listing.pending_periods && listing.pending_periods.length > 0) {
                    buttonClass = 'btn btn-outline-warning';
                    buttonText = '<i class="fas fa-clock"></i> Reserva Pendente';
                    buttonDisabled = 'disabled';
                } else if (listing.available === false && listing.next_available_date) {
                    let availabilityText = `Próxima disponibilidade: ${new Date(listing.next_available_date).toLocaleDateString('pt-BR')}`;
                    
                    // Se há período disponível, mostrar o intervalo
                    if (listing.available_period && listing.available_period.start_date && listing.available_period.end_date) {
                        const startDate = new Date(listing.available_period.start_date).toLocaleDateString('pt-BR');
                        const endDate = new Date(listing.available_period.end_date).toLocaleDateString('pt-BR');
                        
                        if (listing.available_period.start_date === listing.available_period.end_date) {
                            availabilityText = `Disponível em: ${startDate}`;
                        } else {
                            availabilityText = `Disponível de ${startDate} até ${endDate}`;
                        }
                    }
                    
                    availabilityInfo = `
                        <div class="mt-2">
                            <small class="text-warning">
                                <i class="fas fa-exclamation-triangle"></i> Não disponível no período selecionado
                            </small><br>
                            <small class="text-info">
                                <i class="fas fa-calendar-alt"></i> ${availabilityText}
                            </small>
                        </div>`;
                    buttonClass = 'btn btn-outline-secondary';
                    buttonText = '<i class="fas fa-calendar-times"></i> Indisponível';
                    buttonDisabled = 'disabled';
                } else if (listing.available === true) {
                    let availabilityText = 'Disponível no período selecionado';
                    
                    // Se há período disponível, mostrar o intervalo mesmo quando disponível
                    if (listing.available_period && listing.available_period.start_date && listing.available_period.end_date) {
                        const startDate = new Date(listing.available_period.start_date).toLocaleDateString('pt-BR');
                        const endDate = new Date(listing.available_period.end_date).toLocaleDateString('pt-BR');
                        
                        if (listing.available_period.start_date === listing.available_period.end_date) {
                            availabilityText = `Disponível em: ${startDate}`;
                        } else {
                            availabilityText = `Disponível de ${startDate} até ${endDate}`;
                        }
                    }
                    
                    availabilityInfo = `
                        <div class="mt-2">
                            <small class="text-success">
                                <i class="fas fa-check-circle"></i> ${availabilityText}
                            </small>
                        </div>`;
                }
                
                return `
                <div class="col-md-6 col-lg-4">
                    <div class="listing-card">
                        <img src="${listing.image_url || '/static/images/default-listing.jpg'}" 
                             class="card-img-top listing-image" 
                             alt="${listing.title}">
                        <div class="card-body">
                            <h5 class="card-title">${listing.title}</h5>
                            <p class="card-text text-muted">
                                <i class="fas fa-map-marker-alt"></i> ${listing.location}
                            </p>
                            <p class="card-text">${listing.description}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="price-badge">
                                    R$ ${listing.price_per_night}/noite
                                </span>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-info btn-sm" onclick="openCalendarModal(${listing.id}, '${listing.title}')">
                                        <i class="fas fa-calendar-alt"></i> Agenda
                                    </button>
                                    <button class="${buttonClass}" onclick="openReserveModal(${listing.id}, '${listing.title}')" ${buttonDisabled}>
                                        ${buttonText}
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-users"></i> Até ${listing.max_guests} hóspedes
                                </small>
                            </div>
                            ${pendingInfo}
                            ${availabilityInfo}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function openReserveModal(listingId, listingTitle) {
            // Verificar se o usuário está logado E se há datas filtradas
            {% if user_logged_in %}
                if (filteredDate && filteredDate.start && filteredDate.end) {
                    // Usuário logado com datas filtradas - confirmar reserva diretamente
                    confirmAuthenticatedReservation(listingId, listingTitle);
                } else {
                    // Usuário logado sem datas filtradas - abrir modal para selecionar datas
                    document.getElementById('listing-id').value = listingId;
                    document.querySelector('#reserveModal .modal-title').textContent = `Reservar: ${listingTitle}`;
                    
                    // Ocultar campos de dados pessoais para usuários logados
                    document.getElementById('guest-name').closest('.mb-3').style.display = 'none';
                    document.getElementById('guest-email').closest('.mb-3').style.display = 'none';
                    document.getElementById('guest-phone').closest('.mb-3').style.display = 'none';
                    
                    const modal = new bootstrap.Modal(document.getElementById('reserveModal'));
                    modal.show();
                }
            {% else %}
                // Usuário não logado - abrir modal
                document.getElementById('listing-id').value = listingId;
                document.querySelector('#reserveModal .modal-title').textContent = `Reservar: ${listingTitle}`;
                
                // Mostrar campos de dados pessoais para usuários não logados
                document.getElementById('guest-name').closest('.mb-3').style.display = 'block';
                document.getElementById('guest-email').closest('.mb-3').style.display = 'block';
                document.getElementById('guest-phone').closest('.mb-3').style.display = 'block';
                
                // Se há um período filtrado, pré-preencher as datas
                if (filteredDate && filteredDate.start && filteredDate.end) {
                    document.getElementById('check-in').value = filteredDate.start;
                    document.getElementById('check-out').value = filteredDate.end;
                }
                
                const modal = new bootstrap.Modal(document.getElementById('reserveModal'));
                modal.show();
            {% endif %}
        }

        async function confirmReservation() {
            const form = document.getElementById('reserve-form');
            const formData = new FormData(form);
            
            // Verificar se é reserva da agenda ou usuário logado (campos ocultos)
            const isFromCalendar = document.getElementById('guest-name').closest('.mb-3').style.display === 'none';
            const isLoggedUser = {% if user_logged_in %}true{% else %}false{% endif %} && isFromCalendar;
            
            // Validação básica das datas
            const startDate = document.getElementById('check-in').value;
            const endDate = document.getElementById('check-out').value;
            
            if (!startDate || !endDate) {
                alert('Por favor, selecione as datas de check-in e check-out.');
                return;
            }
            
            if (new Date(startDate) >= new Date(endDate)) {
                alert('A data de check-out deve ser posterior à data de check-in.');
                return;
            }
            
            try {
                let response, reservationData, endpoint;
                
                if (isLoggedUser) {
                    // Usuário logado - usar endpoint autenticado
                    reservationData = {
                        listing_id: document.getElementById('listing-id').value,
                        start_date: startDate,
                        end_date: endDate,
                        guests_count: parseInt(document.getElementById('guests-count').value) || 1
                    };
                    endpoint = '/api/anuncios/reservar-autenticado';
                } else {
                    // Usuário não logado ou reserva da agenda - usar endpoint público
                    const guestName = isFromCalendar ? 'Reserva da Agenda' : document.getElementById('guest-name').value;
                    const guestEmail = isFromCalendar ? 'agenda@hostlink.com' : document.getElementById('guest-email').value;
                    const guestPhone = isFromCalendar ? '(00) 00000-0000' : document.getElementById('guest-phone').value;
                    
                    // Validação para usuários não logados
                    if (!isFromCalendar && (!guestName || !guestEmail)) {
                        alert('Por favor, preencha todos os campos obrigatórios.');
                        return;
                    }
                    
                    reservationData = {
                        listing_id: document.getElementById('listing-id').value,
                        guest_name: guestName,
                        guest_email: guestEmail,
                        guest_phone: guestPhone,
                        start_date: startDate,
                        end_date: endDate,
                        guests_count: parseInt(document.getElementById('guests-count').value) || 1
                    };
                    endpoint = '/api/anuncios/reservar';
                }
                
                response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reservationData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Reserva realizada com sucesso!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reserveModal'));
                    modal.hide();
                    form.reset();
                    // Recarregar anúncios para atualizar disponibilidade
                    loadListings();
                } else {
                    alert('Erro ao fazer reserva: ' + (data.error || data.message || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao fazer reserva: ' + error.message);
            }
        }

        function confirmAuthenticatedReservation(listingId, listingTitle) {
            // Verificar se há datas filtradas
            if (!filteredDate || !filteredDate.start || !filteredDate.end) {
                alert('Por favor, selecione um período de datas antes de reservar.');
                return;
            }
            
            // Confirmar com o usuário
            const startDate = new Date(filteredDate.start).toLocaleDateString('pt-BR');
            const endDate = new Date(filteredDate.end).toLocaleDateString('pt-BR');
            const confirmMessage = `Confirmar reserva de "${listingTitle}" de ${startDate} até ${endDate}?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Preparar dados para envio
            const reservationData = {
                listing_id: listingId,
                start_date: filteredDate.start,
                end_date: filteredDate.end,
                guests_count: 1
            };
            
            // Enviar reserva autenticada
            fetch('/api/anuncios/reservar-autenticado', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(reservationData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Reserva confirmada com sucesso!');
                    // Recarregar anúncios para atualizar disponibilidade
                    loadListings();
                } else {
                    alert('Erro ao confirmar reserva: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao processar reserva. Tente novamente.');
            });
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            alert(message);
        }

        // Variáveis globais para o modal do calendário
        let currentModalListingId = null;
        let currentModalAvailability = {};
        let currentModalMonth = new Date().getMonth();
        let currentModalYear = new Date().getFullYear();
        
        // Variáveis para seleção de datas
        let selectedCheckIn = null;
        let selectedCheckOut = null;
        let isSelectingCheckOut = false;

        async function openCalendarModal(listingId, listingTitle) {
            currentModalListingId = listingId;
            currentModalMonth = new Date().getMonth();
            currentModalYear = new Date().getFullYear();
            
            // Resetar seleção de datas
            resetDateSelection();
            
            // Atualizar título do modal
            document.getElementById('calendarModalTitle').innerHTML = 
                `<i class="fas fa-calendar-alt"></i> Agenda de Disponibilidade - ${listingTitle}`;
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('calendarModal'));
            modal.show();
            
            // Carregar dados da agenda
            await loadModalCalendar();
        }

        async function loadModalCalendar() {
            const loadingDiv = document.getElementById('modalCalendarLoading');
            const contentDiv = document.getElementById('modalCalendarContent');
            
            loadingDiv.style.display = 'block';
            contentDiv.innerHTML = '';
            
            try {
                // Fazer chamada paginada com mês e ano específicos
                const response = await fetch(`/api/anuncios/${currentModalListingId}/disponibilidade?month=${currentModalMonth + 1}&year=${currentModalYear}`);
                const data = await response.json();
                
                if (data.success) {
                    currentModalAvailability = data.availability;
                    renderModalCalendar();
                } else {
                    contentDiv.innerHTML = '<div class="alert alert-danger">Erro ao carregar agenda: ' + (data.message || 'Erro desconhecido') + '</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar calendário:', error);
                contentDiv.innerHTML = '<div class="alert alert-danger">Erro ao carregar agenda</div>';
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        async function changeMonth(direction) {
            currentModalMonth += direction;
            
            if (currentModalMonth > 11) {
                currentModalMonth = 0;
                currentModalYear++;
            } else if (currentModalMonth < 0) {
                currentModalMonth = 11;
                currentModalYear--;
            }
            
            // Recarregar dados do novo mês
            await loadModalCalendar();
        }

        function renderModalCalendar() {
            const contentDiv = document.getElementById('modalCalendarContent');
            const monthTitleDiv = document.getElementById('currentMonthTitle');
            
            // Atualizar título do mês
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            monthTitleDiv.textContent = `${monthNames[currentModalMonth]} ${currentModalYear}`;
            
            // Renderizar calendário
            const calendarHTML = renderModalMonth(currentModalMonth, currentModalYear, currentModalAvailability);
            contentDiv.innerHTML = calendarHTML;
            
            // Controlar botões de navegação
            const today = new Date();
            const currentDate = new Date(currentModalYear, currentModalMonth);
            const prevBtn = document.getElementById('prevMonth');
            const nextBtn = document.getElementById('nextMonth');
            
            // Desabilitar botão anterior se estiver no mês atual ou anterior
            prevBtn.disabled = currentDate <= new Date(today.getFullYear(), today.getMonth());
            
            // Limitar a 12 meses no futuro (365 dias como no backend)
            const maxDate = new Date(today.getFullYear(), today.getMonth() + 12);
            nextBtn.disabled = currentDate >= maxDate;
        }

        function renderModalMonth(month, year, availability) {
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            let html = `<div class="calendar-grid">`;
            
            // Cabeçalho dos dias da semana
            dayNames.forEach(day => {
                html += `<div class="calendar-day header">${day}</div>`;
            });
            
            // Dias do mês
            const currentDate = new Date(startDate);
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const isCurrentMonth = currentDate.getMonth() === month;
                    const isAvailable = availability[dateStr] === true;
                    const isPastDate = currentDate < new Date().setHours(0,0,0,0);
                    
                    let dayClass = 'calendar-day';
                    let clickHandler = '';
                    
                    if (!isCurrentMonth) {
                        dayClass += ' other-month';
                    } else if (isPastDate) {
                        dayClass += ' unavailable';
                    } else if (isAvailable) {
                        dayClass += ' available selectable';
                        clickHandler = `onclick="selectDate('${dateStr}')"`;
                        
                        // Verificar se é data selecionada
                        if (selectedCheckIn === dateStr) {
                            dayClass += ' selected-checkin';
                        } else if (selectedCheckOut === dateStr) {
                            dayClass += ' selected-checkout';
                        } else if (selectedCheckIn && selectedCheckOut && dateStr > selectedCheckIn && dateStr < selectedCheckOut) {
                            dayClass += ' in-range';
                        }
                    } else {
                        dayClass += ' unavailable';
                    }
                    
                    html += `<div class="${dayClass}" ${clickHandler}>${currentDate.getDate()}</div>`;
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // Se já passou do mês atual, parar
                if (currentDate.getMonth() !== month && week > 0) break;
            }
            
            html += `</div>`;
            
            return html;
        }
        
        function selectDate(dateStr) {
            const selectedDate = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Não permitir seleção de datas passadas
            if (selectedDate < today) {
                return;
            }
            
            // Se não há check-in selecionado ou se clicou numa data anterior ao check-in
            if (!selectedCheckIn || dateStr <= selectedCheckIn) {
                selectedCheckIn = dateStr;
                selectedCheckOut = null;
                isSelectingCheckOut = true;
            } else if (isSelectingCheckOut) {
                // Validar se todas as datas entre check-in e check-out estão disponíveis
                if (validateDateRange(selectedCheckIn, dateStr)) {
                    selectedCheckOut = dateStr;
                    isSelectingCheckOut = false;
                } else {
                    alert('Existem datas indisponíveis no período selecionado. Por favor, escolha outro intervalo.');
                    return;
                }
            }
            
            updateDateSelection();
            renderModalCalendar();
        }
        
        function validateDateRange(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const current = new Date(start);
            
            while (current <= end) {
                const dateStr = current.toISOString().split('T')[0];
                if (currentModalAvailability[dateStr] !== true) {
                    return false;
                }
                current.setDate(current.getDate() + 1);
            }
            return true;
        }
        
        function updateDateSelection() {
            const checkInElement = document.getElementById('selectedCheckInDate');
            const checkOutElement = document.getElementById('selectedCheckOutDate');
            const reserveBtn = document.getElementById('reserveFromCalendarBtn');
            const selectionInfo = document.getElementById('dateSelectionInfo');
            
            if (selectedCheckIn) {
                checkInElement.textContent = formatDate(selectedCheckIn);
                checkInElement.classList.add('has-date');
                selectionInfo.style.display = 'block';
            } else {
                checkInElement.textContent = 'Selecione uma data';
                checkInElement.classList.remove('has-date');
                selectionInfo.style.display = 'none';
            }
            
            if (selectedCheckOut) {
                checkOutElement.textContent = formatDate(selectedCheckOut);
                checkOutElement.classList.add('has-date');
                reserveBtn.style.display = 'block';
            } else {
                checkOutElement.textContent = 'Selecione uma data';
                checkOutElement.classList.remove('has-date');
                reserveBtn.style.display = 'none';
            }
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR');
        }
        
        function openReserveFromCalendar() {
            if (!selectedCheckIn || !selectedCheckOut) {
                alert('Por favor, selecione as datas de check-in e check-out.');
                return;
            }
            
            // Fechar modal do calendário
            const calendarModal = bootstrap.Modal.getInstance(document.getElementById('calendarModal'));
            calendarModal.hide();
            
            // Preencher dados no modal de reserva
            document.getElementById('listing-id').value = currentModalListingId;
            document.getElementById('check-in').value = selectedCheckIn;
            document.getElementById('check-out').value = selectedCheckOut;
            
            // Ocultar campos desnecessários quando vem da agenda
            document.getElementById('guest-name').closest('.mb-3').style.display = 'none';
            document.getElementById('guest-email').closest('.mb-3').style.display = 'none';
            document.getElementById('guest-phone').closest('.mb-3').style.display = 'none';
            
            // Tornar campos de data readonly
            document.getElementById('check-in').readOnly = true;
            document.getElementById('check-out').readOnly = true;
            
            // Focar no campo de número de hóspedes
            setTimeout(() => {
                document.getElementById('guests-count').focus();
            }, 300);
            
            // Abrir modal de reserva
            const reserveModal = new bootstrap.Modal(document.getElementById('reserveModal'));
            reserveModal.show();
        }
        
        // Resetar seleção ao abrir o modal
        function resetDateSelection() {
            selectedCheckIn = null;
            selectedCheckOut = null;
            isSelectingCheckOut = false;
            updateDateSelection();
        }
        
        // Restaurar campos do modal de reserva
        function resetReserveModal() {
            // Mostrar todos os campos
            document.getElementById('guest-name').closest('.mb-3').style.display = 'block';
            document.getElementById('guest-email').closest('.mb-3').style.display = 'block';
            document.getElementById('guest-phone').closest('.mb-3').style.display = 'block';
            
            // Remover readonly das datas
            document.getElementById('check-in').readOnly = false;
            document.getElementById('check-out').readOnly = false;
            
            // Limpar formulário
            document.getElementById('reserve-form').reset();
        }
        
        // Adicionar event listener para quando o modal de reserva for fechado
        document.getElementById('reserveModal').addEventListener('hidden.bs.modal', resetReserveModal);
    </script>
{% endblock %}